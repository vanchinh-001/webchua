<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Trang qu·∫£n tr·ªã - Susan Shop</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #fdf8f4;
      color: #333;
      margin: 0;
      padding: 0;
    }

    header {
      background: #8b4513;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
    }

    header button {
      background: #fff;
      color: #8b4513;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    header button:hover {
      background: #f0e6df;
    }

    main {
      padding: 30px;
      text-align: center;
    }

    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 80%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      font-size: 15px;
    }

    th {
      background: #8b4513;
      color: white;
    }

    tr:nth-child(even) {
      background: #f9f4ef;
    }

    .no-users {
      margin-top: 30px;
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <h1>üëë Trang qu·∫£n tr·ªã - Susan Shop</h1>
    <button id="logoutBtn">ƒêƒÉng xu·∫•t</button>
  </header>

  <main>
    <h2>Xin ch√†o, <span id="adminName"></span> üëã</h2>
    <h3>Danh s√°ch ng∆∞·ªùi d√πng</h3>

    <table id="userTable">
      <thead>
        <tr>
          <th>H·ªç t√™n</th>
          <th>Email</th>
          <th>M·∫≠t kh·∫©u</th>
          <th>Vai tr√≤</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p id="noUsers" class="no-users" style="display: none;">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o!</p>
  </main>

  <script type="module">
  import { apiGet, apiDelete } from './js/api.js';

    // === Ki·ªÉm tra quy·ªÅn truy c·∫≠p ===
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));

    if (!currentUser || !currentUser.is_admin) {
      alert("üö´ B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang qu·∫£n tr·ªã!");
      window.location.href = "login.html";
    }

    // === Hi·ªÉn th·ªã t√™n admin ===
    document.getElementById("adminName").textContent = currentUser.name || "Admin";

    const tbody = document.querySelector("#userTable tbody");
    const noUsersMsg = document.getElementById("noUsers");

    // Load users: try API first, fallback to localStorage keys
    (async function loadUsers() {
      let users = [];
      try {
        users = await apiGet('users');
      } catch (err) {
        console.warn('API not reachable, falling back to localStorage users', err);
        const localUsers = JSON.parse(localStorage.getItem('localUsers') || '[]');
        const legacy = JSON.parse(localStorage.getItem('users') || '[]');
        users = [...(localUsers || []), ...(legacy || [])];
      }

      // Deduplicate by email (prefer API entry first)
      const map = new Map();
      for (const u of users) {
        if (!u || !u.email) continue;
        if (!map.has(u.email)) map.set(u.email, u);
      }
      const finalUsers = Array.from(map.values());

      if (finalUsers.length === 0) {
        noUsersMsg.style.display = 'block';
        return;
      }

      finalUsers.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.name || ''}</td>
          <td>${u.email || ''}</td>
          <td>${u.password || ''}</td>
          <td>${u.is_admin ? 'Admin' : 'Ng∆∞·ªùi d√πng'}</td>
          <td>${(u.email === currentUser.email) ? '<em>Kh√¥ng th·ªÉ x√≥a</em>' : `<button onclick="deleteUser('${u.id}')">X√≥a</button>`}</td>
        `;
        tbody.appendChild(tr);
      });
    })();

    // === ƒêƒÉng xu·∫•t ===
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("currentUser");
      window.location.href = "login.html";
    });
    
    // X√≥a user (s·ª≠ d·ª•ng API n·∫øu c√≥, fallback localStorage)
    window.deleteUser = async function(id) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?')) return;
      if (!id) return;
      if (id === currentUser.id || id === String(currentUser.id)) {
        alert('B·∫°n kh√¥ng th·ªÉ x√≥a ch√≠nh m√¨nh!');
        return;
      }
      try {
        await apiDelete(`users/${id}`);
        alert('ƒê√£ x√≥a ng∆∞·ªùi d√πng (API)');
        location.reload();
        return;
      } catch (err) {
        console.warn('API delete failed, falling back to localStorage', err);
      }

      // Fallback: remove from localUsers and legacy users
      try {
        const localUsers = JSON.parse(localStorage.getItem('localUsers') || '[]').filter(u => String(u.id) !== String(id));
        localStorage.setItem('localUsers', JSON.stringify(localUsers));
        const legacy = JSON.parse(localStorage.getItem('users') || '[]').filter(u => String(u.id) !== String(id));
        localStorage.setItem('users', JSON.stringify(legacy));
        alert('ƒê√£ x√≥a ng∆∞·ªùi d√πng (offline)');
        location.reload();
      } catch (e) {
        console.error('Failed to delete user in fallback', e);
        alert('Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng hi·ªán t·∫°i');
      }
    };
  </script>
</body>
</html>
