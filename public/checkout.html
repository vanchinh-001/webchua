<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thanh to√°n - Susan Shop</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fffaf5;
      margin: 0;
      color: #333;
    }
    header {
      background: #8b4513;
      color: white;
      padding: 15px;
      text-align: center;
    }
    main {
      max-width: 800px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #f4e1d2;
    }
    button {
      background: #8b4513;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      display: block;
      margin: 0 auto;
    }
    button:hover {
      background: #a0522d;
    }
    footer {
      text-align: center;
      margin-top: 40px;
      color: #888;
    }
  </style>
</head>
<body>
  <header>
    <h1>Thanh to√°n</h1>
    <nav>
      <a href="cart.html" style="color:white;text-decoration:none;">‚Üê Quay l·∫°i gi·ªè h√†ng</a>
    </nav>
  </header>

  <main>
    <h2>Th√¥ng tin ƒë∆°n h√†ng</h2>
    <div id="order-summary"></div>
    <button id="checkout-btn">X√°c nh·∫≠n thanh to√°n</button>
  </main>

  <footer>
    <p>¬© 2025 Susan Shop</p>
  </footer>

  <script type="module">
    const API_URL = "http://localhost:3001";
    const orderSummary = document.getElementById("order-summary");
    const checkoutBtn = document.getElementById("checkout-btn");

  // üõí L·∫•y gi·ªè h√†ng t·ª´ localStorage (key 'cart_items' d√πng b·ªüi js/cart.js)
  const cart = JSON.parse(localStorage.getItem("cart_items") || "[]");
  const user = JSON.parse(localStorage.getItem("currentUser"));

    if (!user) {
      alert("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi thanh to√°n!");
      window.location.href = "login.html";
    }

    if (cart.length === 0) {
      orderSummary.innerHTML = '<p>Gi·ªè h√†ng tr·ªëng, kh√¥ng th·ªÉ thanh to√°n.</p>';
      checkoutBtn.style.display = "none";
    } else {
      let total = 0;
      orderSummary.innerHTML = `
        <table>
          <tr>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th>Gi√°</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>Th√†nh ti·ªÅn</th>
          </tr>
          ${cart.map(item => {
            const subtotal = item.price * item.quantity;
            total += subtotal;
            return `
              <tr>
                <td>${item.name}</td>
                <td>${item.price.toLocaleString()}ƒë</td>
                <td>${item.quantity}</td>
                <td>${subtotal.toLocaleString()}ƒë</td>
              </tr>
            `;
          }).join("")}
          <tr>
            <td colspan="3"><b>T·ªïng c·ªông</b></td>
            <td><b>${total.toLocaleString()}ƒë</b></td>
          </tr>
        </table>
      `;
    }

    // üßæ H√†m t·∫°o ƒë∆°n h√†ng (th√™m log v√† th√¥ng b√°o l·ªói chi ti·∫øt)
    async function createOrder(userId, items) {
      console.log('Creating order for user', userId, 'items:', items);
      const order = {
        user_id: userId,
        created_date: new Date().toISOString(),
        status: "pending"
      };

      // T·∫°o ƒë∆°n h√†ng
      const resOrder = await fetch(`${API_URL}/orders`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(order)
      });

      if (!resOrder.ok) {
        const text = await resOrder.text().catch(() => '');
        throw new Error(`Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng: ${resOrder.status} ${resOrder.statusText} ${text}`);
      }
      const newOrder = await resOrder.json();

      // Th√™m chi ti·∫øt s·∫£n ph·∫©m
      for (const item of items) {
        const productId = item.productId || item.product_id || item.id;
        const detail = {
          order_id: newOrder.id,
          product_id: productId,
          quantity: item.quantity,
          unit_price: item.price
        };

        const resDetail = await fetch(`${API_URL}/order_details`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(detail)
        });

        if (!resDetail.ok) {
          const t = await resDetail.text().catch(() => '');
          console.warn('Kh√¥ng th·ªÉ l∆∞u chi ti·∫øt ƒë∆°n h√†ng', item.name, resDetail.status, t);
        }

        // C·∫≠p nh·∫≠t t·ªìn kho cho bi·∫øn th·ªÉ (n·∫øu variantId c√≥ trong item)
        try {
          const variantId = item.variantId || item.variant_id || item.vId;
          if (variantId) {
            const vRes = await fetch(`${API_URL}/product_variants/${variantId}`);
            if (vRes.ok) {
              const variant = await vRes.json();
              const newQty = Math.max(0, (variant.quantity || 0) - item.quantity);
              await fetch(`${API_URL}/product_variants/${variantId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...variant, quantity: newQty })
              });
            }
          }
        } catch (e) {
          console.warn('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t t·ªìn kho cho bi·∫øn th·ªÉ', e);
        }
      }

      return newOrder;
    }

    // üß† S·ª± ki·ªán thanh to√°n
    checkoutBtn.addEventListener("click", async () => {
      if (cart.length === 0) {
        alert("üõí Gi·ªè h√†ng tr·ªëng!");
        return;
      }

      try {
        const result = await createOrder(user.id, cart);
        console.log('Order created', result);
        // Xo√° gi·ªè h√†ng d√πng key cart_items
        localStorage.removeItem("cart_items");
        alert("‚úÖ Thanh to√°n th√†nh c√¥ng!");
        window.location.href = "thankyou.html";
      } catch (error) {
        console.error("‚ùå L·ªói khi thanh to√°n:", error);
        alert("‚ùå C√≥ l·ªói khi thanh to√°n: " + (error.message || error));
      }
    });
  </script>
</body>
</html>
