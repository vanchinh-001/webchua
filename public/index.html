<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Susan Shop</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #fffaf5;
    }

    header {
      background: #8b4513;
      color: white;
      padding: 15px;
      text-align: center;
    }

    nav a {
      color: #fff;
      text-decoration: none;
      margin: 0 10px;
    }

    .product-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
      padding: 20px;
      max-width: 1100px;
      margin: auto;
    }

    .card {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      text-align: center;
      transition: 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .card p {
      font-size: 13px;
      color: #444;
      padding: 0 10px;
      height: 35px;
      overflow: hidden;
    }

    .card strong {
      color: #b22222;
      display: block;
      margin: 8px 0;
    }

    .add-to-cart {
      background: #8b4513;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
      margin-bottom: 10px;
    }

    .add-to-cart:hover {
      background: #a0522d;
    }

    /* ‚ù§Ô∏è Like area */
    .like-section {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      color: #d32f2f;
      padding-bottom: 8px;
    }

    .like-section span {
      user-select: none;
    }

    /* Footer ƒë·∫πp */
    footer {
      background-color: #8b4513;
      color: #fff;
      text-align: center;
      padding: 25px 10px;
      margin-top: 40px;
    }

    footer h3 {
      margin-bottom: 10px;
      color: #ffd700;
    }

    footer p, footer a {
      color: #fff;
      font-size: 14px;
      margin: 4px 0;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
      color: #ffd700;
    }

    .footer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      text-align: left;
      max-width: 1000px;
      margin: 0 auto 20px;
    }

    .footer-bottom {
      border-top: 1px solid rgba(255,255,255,0.3);
      padding-top: 10px;
      font-size: 13px;
      opacity: 0.8;
    }

  </style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <h1 style="cursor:pointer;"><a href="index.html" style="color:inherit;text-decoration:none;">Susan Shop</a></h1>
    <nav>
      <a href="cart.html">üõí Gi·ªè h√†ng (<span id="cart-count">0</span>)</a>
      <span id="user-info" style="margin-left: 10px;"></span>
      <a href="login.html" id="login-link">ƒêƒÉng nh·∫≠p</a>
      <a href="#" id="logout-link" style="display: none;">ƒêƒÉng xu·∫•t</a>
    </nav>
  </header>

  <!-- MAIN -->
  <main>
    <section style="max-width:1100px;margin:auto;padding:20px 0 0 0;">
      <form id="filter-form" style="display:flex;gap:20px;align-items:center;flex-wrap:wrap;margin-bottom:18px;">
        <label>Lo·∫°i s·∫£n ph·∫©m:
          <select id="category-filter" style="padding:6px 12px;border-radius:6px;border:1px solid #ccc;">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </label>
        <label>Gi√° t·ª´:
          <input type="number" id="min-price" min="0" style="width:90px;padding:6px;border-radius:6px;border:1px solid #ccc;">
        </label>
        <label>ƒë·∫øn:
          <input type="number" id="max-price" min="0" style="width:90px;padding:6px;border-radius:6px;border:1px solid #ccc;">
        </label>
        <button type="submit" style="background:#8b4513;color:#fff;border:none;padding:8px 18px;border-radius:8px;cursor:pointer;">L·ªçc</button>
      </form>
    </section>
    <div id="product-list" class="product-list"></div>
  </main>

  <!-- ‚úÖ FOOTER -->
  <footer>
    <div class="footer-grid">
      <div>
        <h3>üè† V·ªÅ Susan Shop</h3>
        <p>Chuy√™n cung c·∫•p c√† ph√™, b√°nh ng·ªçt v√† ƒë·ªì u·ªëng ch·∫•t l∆∞·ª£ng cao.</p>
        <p>Cam k·∫øt nguy√™n li·ªáu t∆∞∆°i ngon, ph·ª•c v·ª• t·∫≠n t√¢m.</p>
      </div>
      <div>
        <h3>üìû Li√™n h·ªá</h3>
        <p>ƒê·ªãa ch·ªâ: 123 Tr·∫ßn H∆∞ng ƒê·∫°o, Qu·∫≠n 1, TP.HCM</p>
        <p>ƒêi·ªán tho·∫°i: <a href="tel:0123456789">0123 456 789</a></p>
        <p>Email: <a href="mailto:susanshop@gmail.com">susanshop@gmail.com</a></p>
      </div>
      <div>
        <h3>üåê K·∫øt n·ªëi</h3>
        <p><a href="#">Facebook</a> | <a href="#">Instagram</a></p>
        <p><a href="#">TikTok</a> | <a href="#">YouTube</a></p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>¬© 2025 Susan Shop. M·ªçi quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
      <p>Thi·∫øt k·∫ø & ph√°t tri·ªÉn b·ªüi <b>Susan Dev Team</b></p>
    </div>
  </footer>

  <!-- SCRIPT -->
  <script type="module">
    import { getCurrentUser, logout } from "./js/auth.js";
    import { apiGet } from "./js/api.js";
    import { addToCart, getCartCount } from "./js/cart.js";

    const loginLink = document.getElementById("login-link");
    const logoutLink = document.getElementById("logout-link");
    const userInfo = document.getElementById("user-info");
    const cartCount = document.getElementById("cart-count");
    cartCount.innerText = getCartCount();

    const user = getCurrentUser();
    if (user) {
      loginLink.style.display = "none";
      logoutLink.style.display = "inline";
      userInfo.innerHTML = `üë§ Xin ch√†o, <b>${user.name}</b>`;
      logoutLink.addEventListener("click", (e) => {
        e.preventDefault();
        logout();
      });
    } else {
      loginLink.style.display = "inline";
      logoutLink.style.display = "none";
      userInfo.innerHTML = "";
    }

    const productList = document.getElementById("product-list");

    let allProducts = [];
    let allCategories = [];

    async function loadCategories() {
      try {
        allCategories = await apiGet("categories");
        const select = document.getElementById("category-filter");
        select.innerHTML = '<option value="">T·∫•t c·∫£</option>' +
          allCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
      } catch {}
    }

    async function loadProducts() {
      try {
        allProducts = await apiGet("products?_embed=product_variants");
        renderProducts(allProducts);
      } catch (err) {
        console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m:", err);
        productList.innerHTML = `<p>‚ùå Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m. Vui l√≤ng ki·ªÉm tra server JSON.</p>`;
      }
    }

    function renderProducts(products) {
      if (!products || products.length === 0) {
        productList.innerHTML = `<p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o!</p>`;
        return;
      }

      productList.innerHTML = products.map((p) => {
        const variants = p.product_variants || [];
        // Gi√° l·∫•y t·ª´ bi·∫øn th·ªÉ ƒë·∫ßu ti√™n, n·∫øu kh√¥ng c√≥ th√¨ l·∫•y t·ª´ product.price
        let price = p.price || 0;
        if (variants.length > 0 && typeof variants[0].price === "number") {
          price = variants[0].price;
        }
        const img = variants[0]?.image || p.image || "images/no-image.jpg";
        const likes = p.likes || Math.floor(Math.random() * 200 + 10);
        return `
          <div class="card">
            <img src="${img}" alt="${p.name}" onclick="location.href='product.html?id=${p.id}'">
            <div class="like-section">
              ‚ù§Ô∏è <span>${likes}</span> l∆∞·ª£t th√≠ch
            </div>
            <p>${p.detail || ""}</p>
            <strong>${price.toLocaleString()}ƒë</strong>
            <button class="add-to-cart" data-id="${p.id}">Th√™m v√†o gi·ªè</button>
          </div>
        `;
      }).join("");


    document.getElementById("filter-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const cateId = document.getElementById("category-filter").value;
      const min = Number(document.getElementById("min-price").value) || 0;
      const max = Number(document.getElementById("max-price").value) || Infinity;
      let filtered = allProducts;
  if (cateId) filtered = filtered.filter(p => String(p.cate_id) === String(cateId));
      filtered = filtered.filter(p => {
        const variants = p.product_variants || [];
        // N·∫øu c√≥ bi·∫øn th·ªÉ, ki·ªÉm tra t·∫•t c·∫£ bi·∫øn th·ªÉ v√† c·∫£ product.price
        if (variants.length > 0) {
          // N·∫øu product.price n·∫±m trong kho·∫£ng th√¨ c≈©ng cho hi·ªán
          if (p.price >= min && p.price <= max) return true;
          return variants.some(v => v.price >= min && v.price <= max);
        }
        // N·∫øu kh√¥ng c√≥ bi·∫øn th·ªÉ, ki·ªÉm tra gi√° s·∫£n ph·∫©m
        return p.price >= min && p.price <= max;
      });
      renderProducts(filtered);
    });
    document.querySelectorAll(".add-to-cart").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          e.preventDefault();
          // keep id as string to support non-numeric product ids created by admin
          const id = e.target.dataset.id;
          try {
            const productArr = await apiGet(`products?id=${encodeURIComponent(id)}`);
            const product = productArr && productArr[0];
            if (!product) return alert("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†y!");
            const variants = await apiGet(`product_variants?product_id=${encodeURIComponent(id)}`);
            if (!variants || variants.length === 0)
              return alert("S·∫£n ph·∫©m n√†y ch∆∞a c√≥ bi·∫øn th·ªÉ!");
            const v = variants[0];
            addToCart({
              productId: id,
              variantId: v.id,
              name: `${product.name} - ${v.variant_name}`,
              price: v.price,
              quantity: 1,
              image: v.image || product.image || "images/no-image.jpg",
            });
            alert("‚úÖ ƒê√£ th√™m v√†o gi·ªè h√†ng!");
            cartCount.innerText = getCartCount();
          } catch (err) {
            console.error("L·ªói khi th√™m v√†o gi·ªè h√†ng:", err);
            alert("‚ùå Kh√¥ng th·ªÉ th√™m s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i!");
          }
        });
      });
    }

    loadProducts();
  loadCategories();
  // npx json-server --watch db.json --port 3000
  </script>
</body>
</html>
