<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω ƒë∆°n h√†ng</title>
  <style>
    :root{--brand:#8b4513;--accent:#2196f3}
    body {
      font-family: Arial, sans-serif;
      background: #fffaf5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header{background:var(--brand);color:#fff;padding:14px 18px}
    header nav a{color:#ffd700;text-decoration:none;margin:0 8px}
    main{max-width:1100px;margin:26px auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h1, h2 {
      text-align: center;
      color: var(--brand);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #faf0e8;
      color: var(--brand);
    }
    .actions button {
      background-color: var(--accent);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    .actions .delete-btn {
      background-color: #f44336;
    }
    .status-select {
        padding: 6px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }
    .total-amount {
        font-weight: bold;
        color: green;
    }
  </style>
</head>
<body>
  <header>
    <div style="max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Qu·∫£n tr·ªã Susan</h1>
      </div>
      <nav>
        <a href="products-admin.html">S·∫£n ph·∫©m</a> |
        <a href="admin-categories.html">Danh m·ª•c</a> |
        <a href="admin-customers.html">Kh√°ch h√†ng</a> |
        <a href="admin-orders.html" style="text-decoration:underline;color:#fff">ƒê∆°n h√†ng</a>
      </nav>
    </div>
  </header>

  <main>
    <h2>Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>

    <table aria-live="polite">
      <thead>
        <tr>
          <th>ID</th>
          <th>Kh√°ch h√†ng</th>
          <th>Ng√†y ƒë·∫∑t</th>
          <th>T·ªïng ti·ªÅn</th>
          <th>Tr·∫°ng th√°i</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="orderTableBody"></tbody>
    </table>
  </main>

 <script type="module">
    // ƒê·∫£m b·∫£o t·ªáp api.js n·∫±m c√πng c·∫•p ho·∫∑c ƒë√∫ng ƒë∆∞·ªùng d·∫´n
   import { apiGet, apiPost, apiPut, apiDelete } from "./js/api.js";

    const tbody = document.getElementById("orderTableBody");
    const statusOptions = ["pending", "confirmed", "delivering", "delivered", "cancelled"];
    let ordersCache = [];
    let usersCache = {};
    let productsCache = {};

    function formatVND(amount) {
        if (typeof amount !== 'number' || isNaN(amount)) return '0 VNƒê';
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    // H√†m t·ªïng h·ª£p d·ªØ li·ªáu ƒë∆°n h√†ng
    async function fetchAllData() {
        try {
            // 1. T·∫£i t·∫•t c·∫£ d·ªØ li·ªáu c·∫ßn thi·∫øt
            const [orders, orderDetails, users, products] = await Promise.all([
                apiGet("orders"),
                apiGet("order_details"),
                apiGet("users"),
                apiGet("products")
            ]);

            // 2. Chu·∫©n h√≥a d·ªØ li·ªáu Users v√† Products (d√πng ID l√†m key ƒë·ªÉ tra c·ª©u nhanh)
            users.forEach(u => usersCache[String(u.id)] = u);
            products.forEach(p => productsCache[String(p.id)] = p);

            // 3. T√≠nh to√°n Chi ti·∫øt & T·ªïng ti·ªÅn cho t·ª´ng ƒê∆°n h√†ng
            const combinedOrders = orders.map(order => {
                const details = orderDetails.filter(detail => String(detail.order_id) === String(order.id));
                const customer = usersCache[String(order.user_id)] || { name: "Kh√¥ng r√µ", email: "N/A" };
                
                let totalAmount = 0;
                
                // G·∫Øn chi ti·∫øt s·∫£n ph·∫©m v√† t√≠nh t·ªïng ti·ªÅn
                const items = details.map(detail => {
                    const product = productsCache[String(detail.product_id)] || { name: "S·∫£n ph·∫©m kh√¥ng r√µ" };
                    const itemTotal = detail.quantity * detail.unit_price;
                    totalAmount += itemTotal;
                    
                    return {
                        ...detail,
                        name: product.name,
                        itemTotal: itemTotal
                    };
                });

                return {
                    ...order,
                    customerName: customer.name,
                    customerEmail: customer.email,
                    totalAmount: totalAmount,
                    items: items
                };
            }).sort((a, b) => new Date(b.created_date) - new Date(a.created_date)); // S·∫Øp x·∫øp theo ng√†y m·ªõi nh·∫•t

            ordersCache = combinedOrders;
            renderTable();

        } catch (err) {
            alert("L·ªói t·∫£i d·ªØ li·ªáu: " + err.message);
            console.error(err);
        }
    }

    // H√†m hi·ªÉn th·ªã b·∫£ng
    function renderTable() {
        if (ordersCache.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#666;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o.</td></tr>`;
            return;
        }

        tbody.innerHTML = ordersCache.map(o => `
            <tr data-id="${o.id}">
                <td>#${o.id}</td>
                <td>
                    ${o.customerName}
                    <div style="font-size:12px; color:#666;">${o.customerEmail}</div>
                </td>
                <td>${new Date(o.created_date).toLocaleString('vi-VN')}</td>
                <td class="total-amount">${formatVND(o.totalAmount)}</td>
                <td>
                    <select class="status-select" data-id="${o.id}">
                    ${statusOptions.map(s => 
                        `<option value="${s}" ${o.status === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>` // Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu
                    ).join('')}
                    </select>
                </td>
                <td class="actions">
                    <button onclick="viewDetails('${o.id}')">Chi ti·∫øt</button>
                    <button class="delete-btn" onclick="deleteOrder('${o.id}')">üóë X√≥a</button>
                </td>
            </tr>
        `).join('');
    }

    // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi tr·∫°ng th√°i
    tbody.addEventListener('change', async (e) => {
        if (e.target.classList.contains('status-select')) {
            const id = e.target.dataset.id;
            const newStatus = e.target.value;
            
            const currentOrder = ordersCache.find(o => String(o.id) === String(id));
            if (!currentOrder) return;

            if (!confirm(`X√°c nh·∫≠n ƒë·ªïi tr·∫°ng th√°i ƒë∆°n h√†ng #${id} t·ª´ "${currentOrder.status.toUpperCase()}" th√†nh "${newStatus.toUpperCase()}"?`)) {
                e.target.value = currentOrder.status; // Quay l·∫°i tr·∫°ng th√°i c≈©
                return;
            }
            
            try {
                // C·∫≠p nh·∫≠t l√™n JSON Server (ch·ªâ c·∫ßn c·∫≠p nh·∫≠t b·∫£ng "orders")
                await apiPut(`orders/${id}`, { status: newStatus }); 
                
                // C·∫≠p nh·∫≠t cache
                currentOrder.status = newStatus;

                alert(`ƒê∆°n h√†ng #${id} ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh: ${newStatus.toUpperCase()}`);
                renderTable();
            } catch (err) {
                alert('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + err.message);
                e.target.value = currentOrder.status; // Quay l·∫°i tr·∫°ng th√°i c≈© n·∫øu l·ªói
            }
        }
    });

    // H√†m X√≥a ƒë∆°n h√†ng (Global function)
    window.deleteOrder = async function(id) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n h√†ng #${id} (v√† c√°c chi ti·∫øt ƒë∆°n h√†ng li√™n quan)?`)) return;
        try {
            // JSON Server kh√¥ng t·ª± ƒë·ªông x√≥a chi ti·∫øt ƒë∆°n h√†ng, n√™n b·∫°n ph·∫£i x√≥a th·ªß c√¥ng.
            // Tuy nhi√™n, ƒë·ªÉ ƒë∆°n gi·∫£n, ch√∫ng ta ch·ªâ x√≥a ƒë∆°n h√†ng ch√≠nh.
            await apiDelete(`orders/${id}`);
            
            // X√≥a kh·ªèi cache
            ordersCache = ordersCache.filter(o => String(o.id) !== String(id));
            renderTable();
            alert(`ƒê∆°n h√†ng #${id} ƒë√£ ƒë∆∞·ª£c x√≥a!`);
        } catch (err) {
            alert("L·ªói khi x√≥a: " + err.message);
        }
    };
    
    // H√†m Xem chi ti·∫øt
    window.viewDetails = function(id) {
        const order = ordersCache.find(o => String(o.id) === String(id));
        if (!order || !order.items) return;
        
        const itemDetails = order.items.map(item => 
            `- ${item.name || 'S·∫£n ph·∫©m kh√¥ng r√µ'}: SL ${item.quantity} x ${formatVND(item.unit_price)} = ${formatVND(item.itemTotal)}`
        ).join('\n');
        
        alert(
            `CHI TI·∫æT ƒê∆†N H√ÄNG #${order.id}\n` +
            `-----------------------------------\n` +
            `Kh√°ch h√†ng: ${order.customerName} (${order.customerEmail})\n` +
            `Ng√†y ƒë·∫∑t: ${new Date(order.created_date).toLocaleString('vi-VN')}\n` +
            `Tr·∫°ng th√°i: ${order.status.toUpperCase()}\n` +
            `\nS·∫£n ph·∫©m (${order.items.length} lo·∫°i):\n${itemDetails}\n` +
            `\n-----------------------------------\n` +
            `T·ªîNG TI·ªÄN: ${formatVND(order.totalAmount)}`
        );
    };

    // T·∫£i d·ªØ li·ªáu khi trang ƒë∆∞·ª£c load
    fetchAllData();
</script>
</body>
</html>