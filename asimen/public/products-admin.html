<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω s·∫£n ph·∫©m - Susan Shop</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fffaf5;
      margin: 0;
      color: #333;
    }
    header {
      background: #8b4513;
      color: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav a {
      color: white;
      margin: 0 10px;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover { text-decoration: underline; }
    main { padding: 20px; max-width: 1000px; margin: auto; }
    form {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
      margin-bottom: 30px;
    }
    input {
      padding: 8px;
      width: 18%;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background: #8b4513;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #a0522d; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 0 10px #ccc;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #8b4513;
      color: #fff;
    }
    img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üì¶ Qu·∫£n l√Ω s·∫£n ph·∫©m</h1>
    <nav>

      <a href="admin.html">Ng∆∞·ªùi d√πng</a>
      <a href="admin-stats.html">Th·ªëng k√™</a>
      <a href="admin-customers.html">kh√°ch h√†ng</a>
      <a href="products-admin.html">S·∫£n ph·∫©m</a>
      <button id="logoutBtn">ƒêƒÉng xu·∫•t</button>
    </nav>
  </header>

  <main>
    <h2>Th√™m s·∫£n ph·∫©m m·ªõi</h2>
    <form id="addForm">
      <input type="text" id="name" placeholder="T√™n s·∫£n ph·∫©m" required>
      <input type="number" id="price" placeholder="Gi√°" required>
      <input type="text" id="detail" placeholder="M√¥ t·∫£" required>
      <input type="text" id="image" placeholder="Link h√¨nh ·∫£nh" required>
      <input type="number" id="cate_id" placeholder="ID danh m·ª•c (1=Cafe, 2=B√°nh)" required>
      <button type="submit">‚ûï Th√™m</button>
    </form>

    <h2>Danh s√°ch s·∫£n ph·∫©m</h2>
    <table id="productTable">
      <thead>
        <tr>
          <th>·∫¢nh</th>
          <th>T√™n</th>
          <th>Gi√°</th>
          <th>Chi ti·∫øt</th>
          <th>Danh m·ª•c</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script type="module">
  import { apiGet, apiPost, apiDelete } from "./js/api.js";
    const tbody = document.querySelector("#productTable tbody");

    // ‚úÖ Ki·ªÉm tra quy·ªÅn admin
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if (!currentUser || !currentUser.is_admin) {
      alert("üö´ B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!");
      window.location.href = "login.html";
    }

    // üß≠ T·∫£i danh s√°ch s·∫£n ph·∫©m
    async function loadProducts() {
      tbody.innerHTML = "";
      const products = await apiGet("products");
      products.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><img src="${p.image}" alt=""></td>
          <td>${p.name}</td>
          <td>${p.price.toLocaleString ? p.price.toLocaleString() + 'ƒë' : p.price + 'ƒë'}</td>
          <td>${p.detail}</td>
          <td>${p.cate_id}</td>
          <td>
            <button onclick="deleteProduct('${p.id}')">üóëÔ∏è X√≥a</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // üÜï Th√™m s·∫£n ph·∫©m m·ªõi
    document.getElementById("addForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const price = parseFloat(document.getElementById("price").value);
      const detail = document.getElementById("detail").value.trim();
      const image = document.getElementById("image").value.trim();
      const cate_id = parseInt(document.getElementById("cate_id").value);

      if (!name || !price || !detail || !image || !cate_id) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
      }

      try {
        // 1) Create product
        const created = await apiPost("products", { name, price, detail, image, cate_id });

        // 2) Create a default variant so the product can be added to cart immediately
        try {
          const variantPayload = {
            product_id: created.id || created || null,
            variant_name: 'Default',
            price: price,
            quantity: 100,
            image: image
          };
          await apiPost('product_variants', variantPayload);
        } catch (vErr) {
          console.warn('Failed to create default variant for product', vErr);
        }

        alert("‚úÖ Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!");
        e.target.reset();
        loadProducts();
      } catch (err) {
        console.error('Failed to add product', err);
        alert('‚ùå Kh√¥ng th·ªÉ th√™m s·∫£n ph·∫©m (ki·ªÉm tra json-server)');
      }
    });

    // üóëÔ∏è X√≥a s·∫£n ph·∫©m
    window.deleteProduct = async function(id) {
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?")) {
        try {
          await apiDelete(`products/${id}`);
          alert("üóëÔ∏è ƒê√£ x√≥a s·∫£n ph·∫©m!");
          loadProducts();
        } catch (err) {
          console.error('Delete product failed', err);
          alert('‚ùå Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m (ki·ªÉm tra json-server)');
        }
      }
    };

    // üîÅ G·ªçi khi m·ªü trang
    loadProducts();

    // üö™ ƒêƒÉng xu·∫•t
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("currentUser");
      window.location.href = "login.html";
    });
    
  </script>
</body>
</html>
