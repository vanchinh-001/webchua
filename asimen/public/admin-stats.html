<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Th·ªëng k√™ - Susan Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fffaf5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #8b4513;
    }
    .stats-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }
    .stat-card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
      width: 250px;
      border-left: 5px solid #8b4513;
    }
    .stat-card h3 {
      color: #8b4513;
      margin-top: 0;
      font-size: 1.2em;
    }
    .stat-card p {
      font-size: 2.5em;
      font-weight: bold;
      color: #4a280e;
      margin: 10px 0 0;
    }
    .product-list {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .product-list h2 {
      color: #8b4513;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2e3d5;
      color: #8b4513;
    }
  </style>
</head>
<body>
  <h1>B·∫£ng Th·ªëng k√™ T·ªïng quan</h1>

  <div class="stats-container">
    <div class="stat-card">
      <h3>T·ªïng Doanh thu (ƒê√£ ƒë·∫∑t)</h3>
      <p id="total-revenue">ƒêang t·∫£i...</p>
    </div>
    <div class="stat-card">
      <h3>T·ªïng SP ƒë∆∞·ª£c ƒë·∫∑t mua</h3>
      <p id="total-units-sold">ƒêang t·∫£i...</p>
    </div>
    <div class="stat-card">
      <h3>T·ªïng H√†ng t·ªìn</h3>
      <p id="total-stock">ƒêang t·∫£i...</p>
    </div>
  </div>

  <div class="product-list">
    <h2>Th·ªëng k√™ H√†ng t·ªìn chi ti·∫øt</h2>
    <table>
      <thead>
        <tr>
          <th>ID S·∫£n ph·∫©m</th>
          <th>T√™n S·∫£n ph·∫©m</th>
          <th>Gi√° b√°n</th>
          <th>T·ªìn kho</th>
        </tr>
      </thead>
      <tbody id="stock-table-body"></tbody>
    </table>
  </div>
  
  <script type="module">
    import { apiGet } from "./js/api.js";

    function formatVND(amount) {
      if (typeof amount !== 'number' || isNaN(amount)) return '0 VNƒê';
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    async function calculateStatistics() {
      try {
        const [orderDetails, productVariants, products] = await Promise.all([
          apiGet("order_details"),
          apiGet("product_variants"),
          apiGet("products")
        ]);

        const productMap = {};
        products.forEach(p => productMap[String(p.id)] = p);
        
        // üìä Doanh thu v√† s·ªë l∆∞·ª£ng SP ƒë∆∞·ª£c ƒë·∫∑t mua
        let totalRevenue = 0;
        let totalUnitsSold = 0;

        orderDetails.forEach(detail => {
          const quantity = Number(detail.quantity);
          const price = Number(detail.unit_price);
          if (!isNaN(quantity) && !isNaN(price)) {
            totalRevenue += quantity * price;
            totalUnitsSold += quantity;
          }
        });
        
        document.getElementById('total-revenue').textContent = formatVND(totalRevenue);
        document.getElementById('total-units-sold').textContent = totalUnitsSold.toLocaleString('vi-VN');

        // üì¶ H√†ng t·ªìn ‚Äî CH·ªà HI·ªÇN TH·ªä S·∫¢N PH·∫®M C√íN H√ÄNG (> 0)
        let totalStock = 0;
        const stockTableBody = document.getElementById('stock-table-body');
        let stockRows = '';

        productVariants.forEach(variant => {
          const stock = Number(variant.quantity);
          const productId = String(variant.product_id);
          
          // L·ªåC: B·ªè qua s·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng (stock <= 0)
          if (stock <= 0 || isNaN(stock)) return;
          
          // X·ª≠ l√Ω l·ªói "S·∫£n ph·∫©m kh√¥ng r√µ" b·∫±ng c√°ch hi·ªÉn th·ªã ID
          const product = productMap[productId] || { name: `S·∫£n ph·∫©m kh√¥ng r√µ (ID: ${productId})` };

          // C·ªông v√†o t·ªïng t·ªìn kho
          totalStock += stock;
          
          stockRows += `
            <tr>
              <td>${productId}</td>
              <td>${product.name}</td>
              <td>${formatVND(variant.price)}</td>
              <td>${stock.toLocaleString('vi-VN')}</td>
            </tr>
          `;
        });

        document.getElementById('total-stock').textContent = totalStock.toLocaleString('vi-VN');
        stockTableBody.innerHTML = stockRows || `<tr><td colspan="4" style="text-align:center;color:#999;">Kh√¥ng c√≤n s·∫£n ph·∫©m n√†o trong kho</td></tr>`;

      } catch (err) {
        alert("L·ªói khi t·∫£i ho·∫∑c t√≠nh to√°n th·ªëng k√™: " + err.message);
        console.error(err);
        document.getElementById('total-revenue').textContent = "L·ªói";
        document.getElementById('total-units-sold').textContent = "L·ªói";
        document.getElementById('total-stock').textContent = "L·ªói";
      }
    }

    calculateStatistics();
  </script>
</body>
</html>